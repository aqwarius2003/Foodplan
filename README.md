# FoodPlan - Сервис планирования питания

FoodPlan - это веб-сервис, помогающий пользователям планировать питание на неделю. Система предлагает готовые меню с рецептами и автоматически формирует список покупок.

## Функциональные возможности

- Регистрация и авторизация пользователей
- Выбор плана питания из 4 типов меню (Классическое, Низкоуглеводное, Вегетарианское, Кето)
- Подписка на сервис с выбором параметров (срок, приемы пищи, количество персон, аллергены)
- Оплата через ЮКасса (с демо-режимом для разработки)
- Личный кабинет с просмотром активной подписки и меню
- Использование промокодов для получения скидки

## Технологический стек

- Python 3.8+ (проверено на Python 3.11)
- Django 3.2+
- SQLite (для разработки)
- PostgreSQL (опционально, для продакшена)
- Bootstrap 5
- ЮКасса API (в демо-режиме)

## Быстрый запуск проекта

### Windows

1. Запустите `start.bat` для локальной разработки

### Linux/MacOS

1. Запустите `bash start.sh` для локальной разработки

## Ручной запуск проекта для локальной разработки

1. Клонировать репозиторий:
```
git clone <ссылка на репозиторий>
cd Foodplan
```

2. Создать и активировать виртуальное окружение:
```
python -m venv venv
venv\Scripts\activate  # Для Windows
source venv/bin/activate  # Для Linux/Mac
```

3. Установить зависимости:
```
pip install -r requirements.txt
```

4. Применить миграции и запустить сервер:
```
python manage.py migrate
python manage.py createsuperuser  # создание админ-пользователя
python manage.py runserver
```

5. Открыть в браузере: http://127.0.0.1:8000

## Структура проекта

```
foodplan/
├── config/                  # Настройки проекта
├── users/                   # Приложение пользователей
├── subscriptions/           # Приложение подписок
├── recipes/                 # Приложение рецептов
├── orders/                  # Приложение заказов и оплаты
├── templates/               # HTML шаблоны
├── static/                  # CSS, JS, изображения
├── media/                   # Загружаемые файлы
└── manage.py
```

## Тестирование оплаты

Для тестирования используется демо-режим без подключения к ЮКасса API. 
В демо-режиме вы можете использовать кнопки "Оплатить (успешно)" и "Отменить платеж" для симуляции различных сценариев оплаты.

Если вы настроите ключи ЮКасса в `.env` файле, то можете использовать тестовые карты:
- Успешная оплата: `1111 1111 1111 1026`, дата: `12/24`, CVC: `000`
- Неуспешная оплата: `5555 5555 5555 4444`, дата: `12/24`, CVC: `000`

## Лицензия

MIT 

## Подготовка к продакшену

### 1. Экспорт данных из базы данных

#### Экспорт данных

```bash
# Создание JSON-дампа всех данных
python manage.py dumpdata --exclude auth.permission --exclude contenttypes > foodplan_data.json

# Экспорт только рецептов и ингредиентов
python manage.py dumpdata recipes > recipes_data.json
```

#### Экспорт медиафайлов

Скопируйте директории `media` и `static` для переноса изображений:

```bash
# Создание архива с медиафайлами
tar -czf foodplan_media.tar.gz media
```

### 2. Настройка GitHub и Docker

1. Создайте репозиторий на GitHub
2. Добавьте файлы проекта в репозиторий:

```bash
git init
git add .
git commit -m "Initial commit"
git branch -M main
git remote add origin https://github.com/aqwarius2003/Foodplan.git
git push -u origin main
```

3. Убедитесь, что в репозитории есть все необходимые файлы:
   - `Dockerfile.web` - Оптимизированный Dockerfile для Django приложения
   - `docker-compose.yml` - Конфигурация Docker Compose
   - `nginx/Dockerfile.nginx` - Dockerfile для Nginx
   - `nginx/conf/` - Конфигурационные файлы для Nginx
   - `scripts/` - Скрипты для обслуживания контейнеров
   - `.env.example` - Пример переменных окружения

### 3. Развертывание инфраструктуры

#### Структура проекта для Docker

```
foodplan/
├── Dockerfile.web          # Dockerfile для Django приложения
├── docker-compose.yml      # Конфигурация Docker Compose
├── scripts/                # Скрипты для обслуживания
│   ├── backup.sh           # Скрипт для резервного копирования
│   ├── entrypoint.sh       # Скрипт для запуска приложения
│   └── init-healthcheck.py # Скрипт для инициализации проверки здоровья
├── nginx/                  # Конфигурация Nginx
│   ├── Dockerfile.nginx    # Dockerfile для Nginx
│   └── conf/               # Конфигурационные файлы
│       ├── default.conf    # Конфигурация виртуального хоста
│       └── nginx.conf      # Основная конфигурация
├── backups/                # Директория для резервных копий
├── media/                  # Директория для медиа-файлов
└── staticfiles/            # Директория для статических файлов
```

#### Деплой на сервер

1. Клонируйте репозиторий на сервер:

```bash
git clone https://github.com/aqwarius2003/Foodplan.git
cd foodplan
```

2. Создайте необходимые директории:

```bash
mkdir -p nginx/conf nginx/logs nginx/ssl scripts backups media staticfiles
```

3. Настройте переменные окружения:

```bash
cp .env.example .env
nano .env  # Отредактируйте переменные окружения
```

4. Сделайте скрипты исполняемыми:

```bash
chmod +x scripts/*.sh
```

5. Запустите инфраструктуру:

```bash
docker-compose up -d
```

### 4. Мониторинг и обслуживание

#### Мониторинг контейнеров

```bash
# Просмотр логов всех контейнеров
docker-compose logs -f

# Просмотр логов конкретного контейнера
docker-compose logs -f web
docker-compose logs -f nginx
```

#### Ручное резервное копирование

```bash
# Запуск контейнера для резервного копирования
docker-compose run --rm backup
```

#### Восстановление из резервной копии

```bash
# Восстановление базы данных
cat backups/postgres/latest.sql.gz | gunzip | docker-compose exec -T db psql -U postgres -d foodplan

# Восстановление медиа файлов
tar -xzf backups/media/latest.tar.gz -C media
```

#### Проверка работоспособности

```bash
# Проверка всех сервисов
docker-compose ps

# Проверка эндпоинта здоровья
curl https://your-domain.com/health/
```

### 5. Обновление приложения

#### Безопасное обновление

```bash
# Получение последних изменений
git pull

# Перезапуск контейнеров с новой версией
docker-compose down
docker-compose build
docker-compose up -d
```

#### Откат к предыдущей версии

```bash
# Откат к определенному коммиту
git checkout <commit-hash>

# Перезапуск контейнеров с предыдущей версией
docker-compose down
docker-compose build
docker-compose up -d
```

### 6. Безопасность

- SSL-сертификаты настроены и автоматически обновляются с помощью Let's Encrypt
- Все контейнеры используют непривилегированных пользователей
- Пароли и чувствительные данные хранятся в переменных окружения
- Регулярное резервное копирование обеспечивает сохранность данных 

## Установка на сервер с Traefik

### Предварительные требования
- Docker и Docker Compose установлены на сервере
- Traefik уже настроен и запущен на сервере
- Домен настроен и указывает на IP сервера

### Шаги установки

1. Создайте внешнюю сеть Traefik (если еще не создана):
```bash
docker network create traefik-public
```

2. Склонируйте репозиторий:
```bash
git clone https://github.com/yourusername/foodplan.git
cd foodplan
```

3. Создайте файл .env на основе .env.example:
```bash
cp .env.example .env
```

4. Настройте переменные окружения в .env:
```bash
nano .env
```

5. Запустите приложение:
```bash
docker-compose up -d
```

### Особенности конфигурации с Traefik

- Traefik автоматически обнаруживает сервисы и настраивает маршрутизацию
- SSL/TLS сертификаты управляются через Traefik
- Приложение доступно только через HTTPS
- Статические файлы обслуживаются через Django
- Сеть foodplan-network изолирована от других проектов

### Мониторинг

- Traefik Dashboard доступен по адресу: http://your-server-ip:8080
- Статус контейнеров: `docker-compose ps`
- Логи: `docker-compose logs -f`

### Преимущества использования Traefik

1. **Автоматизация**: 
   - Автоматическое обнаружение сервисов
   - Автоматическое обновление SSL сертификатов
   - Динамическая конфигурация маршрутизации

2. **Безопасность**:
   - Изоляция сетей между проектами
   - Централизованное управление SSL/TLS
   - Встроенная защита от DDoS

3. **Масштабируемость**:
   - Легкое добавление новых проектов
   - Простое управление несколькими доменами
   - Гибкая настройка маршрутизации

4. **Мониторинг**:
   - Встроенный dashboard
   - Метрики и логи
   - Состояние сервисов 